{% extends "layout.html" %}

{% block content %}
    <link href="{{ url_for('static', filename='css/better_digits.css') }}" rel="stylesheet">
  <main class="hero-section">
  	<div>
  	<h2>Handwritten Digit Recognition</h2>
    <div class="container" id = "interact">

		<h3>Draw a digit inside this box!</h3>

		<canvas id="canvas" width="1000" height="1000" style="border:3px solid; border-radius: 3px; cursor: crosshair;z-index:1"></canvas>
		<canvas id="canvas_preds" width="1000" height="1000" style="border:3px solid; border-radius: 3px; cursor: crosshair; z-index: -1"></canvas>
		<div id="controls">
			
<!-- 			<input type="color" id="colors">
			 <input type="number" id="lineWidth" style="width:60px" value="0.2" step="0.1" min="0.1"> -->
			 <!-- <a href="#" class="submitButton"><span> Predict </span></a>	 -->
			<input type="button" id="clearButton" value="Clear" >
				
		</div>

</div>
		<div class = "container" id = "results">
			<h1 id="result" style="margin-right:20px; margin-top:300px;float:left;"><span> </span></h1>
		</div>

		
  		<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

	    <script src="static/js/better_digits.js"></script>
	    


	    <script type="text/javascript">


	   		var mousePress = false;

	   		canvas.onmousedown = function(e){
	   			mousePress = true;
	   			getPred();
				}

			canvas.onmouseup = function(e){
				mousePress = false;
				getPred();
				setTimeout(getPred, 500); //to eliminate residual boxes
			}


			function removeColor(color){
				var canvasData = ctx.getImageData(0,0,600,800),
				pix = canvasData.data;

				for(var i=0, n =pix.length; i<n; i+=4){
					if(pix[i]===color[0] && pix[i+1]===color[1] && pix[i+2]===color[2]){
						pix[i+3] = 0;
					}
				}
				ctx.putImageData(canvasData, 0, 0);
			}


		  	function getPred(){
	   			var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
	   			var canvasObj = document.getElementById("canvas");
	   			var img = canvasObj.toDataURL();
	   			ctx = canvasObj.getContext("2d");

	   			var canvasObj_pred = document.getElementById("canvas_preds");
	   			ctx_pred = canvasObj_pred.getContext("2d");

	   			ctx_pred.strokeStyle = 'white'; // gets rid of residual boxes for some reason...?
	   			ctx_pred.beginPath(); 
	   			ctx_pred.moveTo(1550, 0);
	   			ctx_pred.lineTo(1550, 50);
	   			ctx_pred.stroke();


				ctx_pred.clearRect( 0, 0, 1500, 1500 );
				ctx_pred.fillStyle="white";
				ctx_pred.fillRect(0,0,canvas.width,canvas.height);
	   			ctx_pred.drawImage(canvasObj, 0, 0);






	   			$.ajax({
	   				type: "POST",
	   				url: $SCRIPT_ROOT + "/predict_better_digits",
	   				data: img,
	   				success: function(data){
	   					var dim1 = data.dim1_list;
	   					var dim2 = data.dim2_list;
	   					var preds = data.predictions;

	   					var i = 0;
	   					for(; i < dim1.length; i ++){

		   					ctx_pred.font = "40px Arial";
		   					ctx_pred.fillStyle = "#4285f4";
		   					ctx_pred.lineWidth = 2;
		   					ctx_pred.strokeStyle = "#4285f4";

		   					ctx_pred.rect(dim1[i][0], dim1[i][1], dim2[i][0]-dim1[i][0], dim2[i][1]-dim1[i][1]);
		   					ctx_pred.fillText(preds[i], dim1[i][0], dim1[i][1] )

		   					ctx_pred.stroke();	   				
	   					}

	   					console.log(dim1);
	   					console.log(dim2);


	   					ctx.lineWidth = 15; //change width back to normal after the stroke

	   				}
	   			});		  		
		  	}

		  	var counter = 0;

		  	var timeUpdate = 5 // in 100*ms

		  	function timer(){
		  		// if(counter == timeUpdate){
		  		// 	getPred();
		  		// }
		  		if(counter <= timeUpdate){
			  		counter = counter + 1;
			  	}
			  	else{
			  		counter = 0
			  	}
		  	}

		  	setInterval(timer, 100); 



	   		document.getElementById("canvas").onmousemove = function(e){
	   			var canvasObj_pred = document.getElementById("canvas_preds");
	   			ctx_pred = canvasObj_pred.getContext("2d");
	   			
	   			if(!mousePress) return;

				while(mousePress){
		   			if(counter == timeUpdate){
		   				getPred();
		   			}


		   			return false;
		   		}
		   	};




	   			   </script>

</div>
  </main>
  <div class="clearfix"></div>

<!-- <hr>
<div class = 'div_graph'>
	<h2>Model Architecture </h2> 
	<h3>Convolutional Neural Network</h3> <br>
<img class = 'graph' src = "{{ url_for('static', filename='img/digits_cnn2.svg') }}"> </img>
</div>
<br> -->

{% endblock %}

